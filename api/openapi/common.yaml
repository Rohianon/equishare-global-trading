# =============================================================================
# Common OpenAPI Components
# =============================================================================
# Shared schemas, parameters, and responses used across all service specs.
# Import this file using $ref in service-specific specs.
# =============================================================================

openapi: "3.1.0"
info:
  title: EquiShare Common Components
  version: "1.0.0"

components:
  # ===========================================================================
  # Response Envelope Schemas
  # ===========================================================================
  schemas:
    # Standard success response wrapper
    SuccessResponse:
      type: object
      properties:
        data:
          description: Response payload (varies by endpoint)
        meta:
          $ref: "#/components/schemas/Meta"
      required:
        - meta

    # Standard error response wrapper
    ErrorResponse:
      type: object
      properties:
        error:
          $ref: "#/components/schemas/ErrorBody"
        meta:
          $ref: "#/components/schemas/Meta"
      required:
        - error
        - meta

    # Error details
    ErrorBody:
      type: object
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid input"
        details:
          type: array
          items:
            type: string
          description: Additional error details
          example: ["field 'email' is required"]
      required:
        - code
        - message

    # Request metadata
    Meta:
      type: object
      properties:
        request_id:
          type: string
          format: uuid
          description: Unique request identifier for tracing
          example: "550e8400-e29b-41d4-a716-446655440000"
        timestamp:
          type: string
          format: date-time
          description: Response timestamp (UTC)
          example: "2026-01-31T12:00:00Z"
        version:
          type: string
          description: API version
          example: "v1"
      required:
        - request_id
        - timestamp

    # Pagination wrapper
    PaginatedResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              description: List of items
            pagination:
              $ref: "#/components/schemas/Pagination"
        meta:
          $ref: "#/components/schemas/Meta"

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: Current page number (1-indexed)
          example: 1
        per_page:
          type: integer
          description: Items per page
          example: 20
        total:
          type: integer
          format: int64
          description: Total number of items
          example: 100
        total_pages:
          type: integer
          description: Total number of pages
          example: 5
        has_more:
          type: boolean
          description: Whether there are more pages
          example: true
      required:
        - page
        - per_page
        - total
        - total_pages
        - has_more

    # ===========================================================================
    # Common Domain Schemas
    # ===========================================================================

    # User representation
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: User unique identifier
        phone:
          type: string
          description: Phone number in E.164 format
          example: "+254712345678"
        email:
          type: string
          format: email
          description: Email address (optional)
        first_name:
          type: string
          description: First name
        last_name:
          type: string
          description: Last name
        kyc_status:
          type: string
          enum: [none, pending, verified, rejected]
          description: KYC verification status
        kyc_tier:
          type: string
          enum: [none, basic, full]
          description: KYC verification tier
        is_active:
          type: boolean
          description: Whether account is active
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # Wallet representation
    Wallet:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        currency:
          type: string
          example: "KES"
        balance:
          type: number
          format: double
          description: Available balance
          example: 10000.00
        locked_balance:
          type: number
          format: double
          description: Balance locked in pending orders
          example: 500.00
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # Order representation
    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        symbol:
          type: string
          description: Stock symbol
          example: "AAPL"
        side:
          type: string
          enum: [buy, sell]
        type:
          type: string
          enum: [market, limit]
        status:
          type: string
          enum: [pending, submitted, partial_fill, filled, cancelled, rejected]
        qty:
          type: number
          format: double
          description: Quantity (fractional shares supported)
        filled_qty:
          type: number
          format: double
        limit_price:
          type: number
          format: double
          description: Limit price (for limit orders)
        filled_avg_price:
          type: number
          format: double
        created_at:
          type: string
          format: date-time
        filled_at:
          type: string
          format: date-time
        cancelled_at:
          type: string
          format: date-time

    # Position/holding representation
    Position:
      type: object
      properties:
        symbol:
          type: string
          example: "AAPL"
        qty:
          type: number
          format: double
          description: Number of shares held
        avg_entry_price:
          type: number
          format: double
        market_value:
          type: number
          format: double
        cost_basis:
          type: number
          format: double
        unrealized_pl:
          type: number
          format: double
          description: Unrealized profit/loss
        unrealized_plpc:
          type: number
          format: double
          description: Unrealized P/L percentage
        current_price:
          type: number
          format: double

    # Stock quote
    Quote:
      type: object
      properties:
        symbol:
          type: string
        bid_price:
          type: number
          format: double
        ask_price:
          type: number
          format: double
        last_price:
          type: number
          format: double
        volume:
          type: integer
          format: int64
        timestamp:
          type: string
          format: date-time

    # Money amount with currency
    Money:
      type: object
      properties:
        amount:
          type: number
          format: double
          example: 1000.00
        currency:
          type: string
          example: "KES"
      required:
        - amount
        - currency

  # ===========================================================================
  # Common Parameters
  # ===========================================================================
  parameters:
    PageParam:
      name: page
      in: query
      description: Page number (1-indexed)
      schema:
        type: integer
        minimum: 1
        default: 1

    PerPageParam:
      name: per_page
      in: query
      description: Items per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    IdParam:
      name: id
      in: path
      required: true
      description: Resource ID
      schema:
        type: string
        format: uuid

    SymbolParam:
      name: symbol
      in: path
      required: true
      description: Stock symbol
      schema:
        type: string
        example: "AAPL"

  # ===========================================================================
  # Common Responses
  # ===========================================================================
  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid input"
              details: ["field 'phone' is required"]
            meta:
              request_id: "550e8400-e29b-41d4-a716-446655440000"
              timestamp: "2026-01-31T12:00:00Z"

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: "UNAUTHORIZED"
              message: "Authentication required"
            meta:
              request_id: "550e8400-e29b-41d4-a716-446655440000"
              timestamp: "2026-01-31T12:00:00Z"

    Forbidden:
      description: Access denied
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: "FORBIDDEN"
              message: "Access denied"
            meta:
              request_id: "550e8400-e29b-41d4-a716-446655440000"
              timestamp: "2026-01-31T12:00:00Z"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: "NOT_FOUND"
              message: "Resource not found"
            meta:
              request_id: "550e8400-e29b-41d4-a716-446655440000"
              timestamp: "2026-01-31T12:00:00Z"

    Conflict:
      description: Resource conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: "RATE_LIMITED"
              message: "Too many requests, please try again later"
            meta:
              request_id: "550e8400-e29b-41d4-a716-446655440000"
              timestamp: "2026-01-31T12:00:00Z"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred"
            meta:
              request_id: "550e8400-e29b-41d4-a716-446655440000"
              timestamp: "2026-01-31T12:00:00Z"

  # ===========================================================================
  # Security Schemes
  # ===========================================================================
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /auth/login or /auth/verify
